import os
import time
import requests
import arrow
import pandas as pd
from loguru import logger
from typing import List, Dict, Tuple

# 引入项目配置的 Key
try:
    from conf.keys import Keys
except ImportError:
    import sys

    sys.path.append(os.path.dirname(os.path.abspath(__file__)))
    from conf.keys import Keys

# --- 配置区域 ---
YEAR = 2025
API_BASE = "https://api.ioc-sealevelmonitoring.org/v2/stations/{code}/data"
HEADERS = {
    'accept': 'application/json',
    'X-API-KEY': Keys.ioc_api_token
}
OUTPUT_DIR = "annual_data_2025"
FAILED_LOG_FILE = "failed_tasks.csv"  # 失败记录文件


def generate_time_chunks(year: int, step_days: int = 30) -> List[Dict[str, str]]:
    """生成一年的时间分片"""
    start_of_year = arrow.get(f"{year}-01-01")
    end_of_year = arrow.get(f"{year + 1}-01-01")

    chunks = []
    current = start_of_year

    while current < end_of_year:
        next_step = current.shift(days=step_days)
        if next_step > end_of_year:
            next_step = end_of_year

        chunks.append({
            'start': current.format('YYYY-MM-DDTHH:mm'),
            'end': next_step.format('YYYY-MM-DDTHH:mm')
        })
        current = next_step

    return chunks


def fetch_station_annual_data(station_code: str) -> Tuple[List[Dict], List[Dict]]:
    """
    获取指定站点全年的数据
    :return: (all_data_list, failed_chunks_list)
    """
    time_chunks = generate_time_chunks(YEAR, step_days=30)
    all_data = []
    failed_chunks = []  # 用于记录失败的片段

    logger.info(f"开始获取站点 [{station_code}] {YEAR} 年全量数据，共 {len(time_chunks)} 个请求片段...")

    for i, chunk in enumerate(time_chunks):
        timestart = chunk['start']
        timestop = chunk['end']

        # 构造 URL 和 参数
        url = API_BASE.format(code=station_code)
        params = {
            'timestart': timestart,
            'timestop': timestop,
            'nofilter': 'false',
            'allsensors': 'false',
            'skip_gaps_until': f"{YEAR + 1}-01-05T00:00"
        }

        try:
            logger.info(f"[{station_code}] 请求片段 {i + 1}/{len(time_chunks)}: {timestart} -> {timestop}")
            resp = requests.get(url, headers=HEADERS, params=params, timeout=30)

            # 情况1: HTTP 状态码非 200
            if resp.status_code != 200:
                logger.error(f"  - 请求失败 Status: {resp.status_code}, Msg: {resp.text[:100]}")
                failed_chunks.append({
                    'code': station_code,
                    'start': timestart,
                    'end': timestop,
                    'reason': f"HTTP {resp.status_code}"
                })
                continue  # 跳过本次处理

            # 情况2: JSON 解析失败 (你遇到的 Expecting value 错误通常在这里触发)
            try:
                data = resp.json()
                if isinstance(data, list):
                    all_data.extend(data)
                    logger.debug(f"  - 获取到 {len(data)} 条数据")
                else:
                    # 返回了 JSON 但不是列表（可能是包含错误信息的字典）
                    logger.warning(f"  - 响应格式非列表: {str(data)[:100]}")
                    failed_chunks.append({
                        'code': station_code,
                        'start': timestart,
                        'end': timestop,
                        'reason': "Not a list"
                    })

            except ValueError as json_err:
                # 捕获 JSONDecodeError
                logger.error(f"  - JSON解析失败: {json_err}")
                failed_chunks.append({
                    'code': station_code,
                    'start': timestart,
                    'end': timestop,
                    'reason': "JSON Decode Error"
                })

        except Exception as e:
            # 情况3: 网络超时、连接断开等其他异常
            logger.error(f"  - 请求网络异常: {e}")
            failed_chunks.append({
                'code': station_code,
                'start': timestart,
                'end': timestop,
                'reason': str(e)
            })

        # 礼貌性延迟
        time.sleep(1)

    return all_data, failed_chunks


def save_to_csv(station_code: str, data_list: List[Dict]):
    """保存成功获取的数据"""
    if not data_list:
        return

    if not os.path.exists(OUTPUT_DIR):
        os.makedirs(OUTPUT_DIR)

    try:
        df = pd.DataFrame(data_list)
        if 'slevel' in df.columns and 'stime' in df.columns:
            target_cols = ['stime', 'slevel', 'sensor']
            if 'sensor' not in df.columns:
                df['sensor'] = 'unknown'

            df = df[target_cols]
            df['stime'] = df['stime'].astype(str).str.strip()

            filename = f"{station_code}_{YEAR}_utc.csv"
            filepath = os.path.join(OUTPUT_DIR, filename)

            df.to_csv(filepath, index=False, encoding='utf-8-sig')
            logger.success(f"站点 [{station_code}] 数据保存完毕 (共 {len(df)} 条)")
    except Exception as e:
        logger.error(f"保存数据 CSV 失败: {e}")


def save_failures(failed_list: List[Dict]):
    """
    将失败的任务统一保存到一个 CSV 文件中
    方便后续读取并重新执行
    """
    if not failed_list:
        return

    filepath = os.path.join(OUTPUT_DIR, FAILED_LOG_FILE)

    try:
        df = pd.DataFrame(failed_list)
        # 模式 'a' (append) 追加写入，如果文件不存在则写入表头
        header = not os.path.exists(filepath)
        df.to_csv(filepath, mode='a', index=False, header=header, encoding='utf-8-sig')
        logger.warning(f"⚠️ 已追加 {len(failed_list)} 条失败记录至: {filepath}")
    except Exception as e:
        logger.error(f"保存失败记录出错: {e}")


def main():
    target_stations = [
        #  'waka',
        # 'abas',
        # 'hana',
        # 'kush',
        'hako',
        'fuka',
        'ofun',
        'sado',
        'noto',
        'toya',
        'mera',
        'omae',
        'kusm',
        'saig',
        'hmda',
        'tosa',
        'naga',
        'abur',
        'naha',
        'ishi',
        'busa',
        'curri',
        'subi',
        'mani',
        'luba',
        'lega',
        'davo',
        'quin',
        'vtau',
        'darw',
        'brom',
        'phcp',
        'pmur',
        'gpab',
        'hill',
        'espe',
        'thev',
        'porl',
        'barn',
        'sprg',
        'bapj',
        'spjy',
        'tbwc',
        'pkem',
        'gcsb',
        'ross',
        'ferg',
        'lirf',
        'trst',
        'groo',
        'lomb',
        'tare',
        'lata',
        'luga',
        'litz',
        'vanu',
        'lena',
        'hien',
        'thio',
        'ouin',
        'numbo',
        'ouve',
        'lifo',
        'vati',
        'levu',
        'viti',
        'upol',
        'pago',
        'ncpt',
        'gbit',
        'auct',
        'mnkt',
        'taut',
        'lott',
        'gist',
        'napt',
        'cpit',
        'wlgt',
        'chst',
        'kait',
        'sumt',
        'jack',
        'otat',
        'puyt',
        'chit',
        'quepo',
        'psjs',
        'psdn',
        'laun',
        'lalb',
        'acaj',
        'made',
        'sali2',
        'huat2',
        'ptan2',
        'zihu2',
        'laza2',
        'mnza',
        'puert',
        'lpaz2',
        'alva2',
        'ccar',
        'camt',
        'sisa',
        'telc',
        'imuj2',
        'clst',
        'sand',
        'losa',
        'pslu',
        'mont2',
        'alam',
        'fpnt',
        'aren2',
        'cres',
        'char',
        'sbea2',
        'asto2',
        'wpwa',
        'epme2',
        'cwme2',
        'bame2',
        'ptme',
        'boma',
        'wood2',
        'mony2',
        'bgct2',
        'btny2',
        'acnj2',
        'cmnj2',
        'cbmd2',
        'dpnc',
        'benc2',
        'fpga2',
        'fbfl2',
        'cwfl2',
        'apfl2',
        'pnfl2',
        'dial',
        'wlms',
        'psla2',
        'gila',
        'cpla',
        'gptx',
        'lime2',
        'stcr2',
        'lame',
        'amal2',
        'isab',
        'vieq2',
        'faja',
        'yabu',
        'sanj2',
        'stdpr',
        'aracS',
        'gtdpr',
        'maya',
        'setp1',
        'pobe',
        'cabc',
        'prba',
        'pcor',
        'rtas',
        'ceib',
        'cois',
        'sana',
        'limon',
        'bdto',
        'elpo',
        'sapz2',
        'cove',
        'inav',
        'cart',
        'sama',
        'oran',
        'bull',
        'gale',
        'ptsp',
        'scar',
        'pric',
        'calq',
        'chat',
        'stlu4',
        'stlu3',
        'stlu2',
        'stlu',
        'ftfr2',
        'lero',
        'rose',
        'ptmd2',
        'ptpt2',
        'desi',
        'desh',
        'bass',
        'blow',
        'ptca',
        'ptpl',
        'bara',
        'caph',
        'ptpr',
        'slds',
        'jrmi',
        'malo',
        'treg',
        'kungr',
        'smog',
        'brof',
        'mard',
        'sten',
        'udde',
        'vin2',
        'gokr',
        'goto',
        'tang',
        'onsa',
        'ring',
        'varb',
        'falk',
        'halm',
        'vikew',
        'hels',
        'bars',
        'maha',
        'klag',
        'sass',
        'warn',
        'horn',
        'helg',
        'cuxh',
        'bork',
        'delf',
        'ters',
        'harl',
        'denh',
        'sche',
        'hoek',
        'euro',
        'vlrn',
        'vlis',
        'trnz',
        'oste',
        'diep2',
        'ouis2',
        'cher2',
        'diel2',
        'wick',
        'abed',
        'leit',
        'nshi',
        'whit',
        'immi',
        'crom',
        'lowe',
        'harw',
        'shee',
        'hbay',
        'dove',
        'hasp',
        'nhav',
        'ptmt',
        'bour',
        'weym',
        'wbhb',
        'plym',
        'ilfa',
        'barm',
        'work',
        'rodr',
        'ptlu',
        'blueb',
        'reun2',
        'toam2',
        'laru2',
        'garc',
        'zanz',
        'momb',
        'lamu',
        'sala',
        'duqm',
        'masi',
        'ashk',
        'suro',
        'qura',
        'wuda',
        'maji',
        'diba',
        'gwda',
        'orma',
        'kara',
        'verav',
        'marm',
        'coch',
        'mini',
        'hani',
        'male',
        'colo',
        'trin',
        'chenn',
        'vish',
        'chtt',
        'sitt',
        'hain',
        'ptbl',
        'nanc',
        'saba',
        'lank',
        'ms002',
        'ms004',
        'ms005',
        'ms006',
        'sibo',
        'sebe',
        'maju',
        'koli',
        'pand',
        'cili',
        'sema',
        'sadp',
        'prig',
        'sura',
        'beno',
        'lemba',
        'ambon',
        'saum',
        'tanp',
        'tboz',
        'tche',
        'tcim',
        'tdan',
        'tdas',
        'tdaw',
        'tdog',
        'tdoj',
        'tdos',
        'tfan',
        'tfug',
        'tful',
        'thep',
        'thou',
        'thsi',
        'tjhu',
        'tjia',
        'tjib',
        'tkao',
        'tkee',
        'tlan',
        'tlia',
        'tlin',
        'tlon',
        'tlyu',
        'tmai',
        'tmat',
        'tnan',
        'tpen',
        'tshi',
        'tshu',
        'tsic',
        'tsua',
        'tsyu',
        'ttai',
        'twai',
        'twun',
        'twus',
        'txig',
        'txil',
        'tyon',
        'tzha',
        'quar',
        'shek',
        'shen',
        'zhap',
        'qing',
        'aarh',
        'acap',
        'acnj',
        'acor1',
        'acya',
        'adak',
        'adak2',
        'aden',
        'agal',
        'agua',
        'aigi',
        'ajac',
        'ajac2',
        'alac1',
        'alac2',
        'alak2',
        'alawa',
        'albo',
        'albu',
        'alcu',
        'aler',
        'ales',
        'alex',
        'alex2',
        'alex3',
        'alge',
        'alme',
        'alme2',
        'alofi',
        'alva',
        'amal',
        'amas',
        'amor',
        'AMTSI',
        'AN15',
        'anch',
        'anch2',
        'ancu',
        'ancu2',
        'ande',
        'angu',
        'anta',
        'anti',
        'anto',
        'anto2',
        'apfl',
        'apla',
        'aqab',
        'arca',
        'arca2',
        'aren',
        'aric',
        'aric2',
        'arko',
        'arrc',
        'arre',
        'arri',
        'arsu',
        'ascen',
        'ashd',
        'ashd1',
        'askl',
        'asro',
        'asto',
        'atic',
        'atka',
        'auasi',
        'audi',
        'audi2',
        'aunuu',
        'avon',
        'AZ42',
        'BA05',
        'baka',
        'balc',
        'ball',
        'balt',
        'bamd',
        'bame',
        'bamf',
        'bang',
        'BANSI',
        'barb2',
        'barc',
        'barc2',
        'batr1',
        'bayo',
        'bbbc',
        'bbst',
        'bbst2',
        'bcar',
        'bcon',
        'bele',
        'benc',
        'berg',
        'BETSI',
        'bgct',
        'bil3',
        'bitu',
        'blkw',
        'blri',
        'bmda',
        'bmsa',
        'bmsa2',
        'bmsg',
        'bmso',
        'bnjl',
        'bodo',
        'bodr',
        'bois',
        'bon2',
        'bona',
        'bouc',
        'bouc2',
        'boul',
        'boye',
        'boye2',
        'bozc',
        'bozy',
        'bres',
        'bres2',
        'brid2',
        'BRLT',
        'brpt',
        'brsk',
        'brur',
        'bspe',
        'btny',
        'buca',
        'buve',
        'buve2',
        'buve3',
        'CA02',
        'cabo',
        'cacb',
        'cadi1',
        'cagb',
        'cala',
        'calc',
        'cald',
        'cald2',
        'call',
        'camu',
        'cara',
        'carb',
        'carg1',
        'casc',
        'cast',
        'cazul',
        'cbmd',
        'cbva',
        'cctx',
        'cdtt',
        'cedr',
        'cent',
        'cent2',
        'CETR',
        'ceut',
        'ceut1',
        'CF06',
        'chab',
        'chala',
        'chan',
        'char2',
        'cher',
        'chia',
        'chij',
        'chim2',
        'chimb',
        'chnr',
        'chnr2',
        'chrl',
        'chrp',
        'chrs',
        'chuu',
        'CI20',
        'CIDJI',
        'ciut',
        'cmet',
        'cmet3',
        'cmnj',
        'cnme',
        'cocb',
        'cocos',
        'colb',
        'coli',
        'coli2',
        'como',
        'conc',
        'conc2',
        'cons2',
        'const',
        'coqu',
        'coqu2',
        'cor2',
        'cord',
        'corf',
        'corn',
        'corr',
        'corr2',
        'CR08',
        'crbc',
        'crnl',
        'crnl2',
        'csta',
        'csta2',
        'csta3',
        'cstr',
        'cstr2',
        'CT03',
        'cuaj',
        'cule',
        'cuvie',
        'cwfl',
        'cwme',
        'dacp',
        'dacp2',
        'dada',
        'dadk',
        'dadk2',
        'dakar',
        'danc',
        'dapi',
        'dapi2',
        'dar2',
        'dara',
        'dasa',
        'dat2',
        'dat3',
        'dat4',
        'datl',
        'datu',
        'datu2',
        'dbal',
        'dbba',
        'dber',
        'dber2',
        'dcal',
        'dcal2',
        'dcar',
        'dcar2',
        'dch2',
        'dch3',
        'dch4',
        'dchi',
        'dchr',
        'dchr2',
        'dchu',
        'dcld',
        'dcld2',
        'dcol',
        'dcor',
        'dcor2',
        'dcr2',
        'dcr3',
        'dcss',
        'deke',
        'delo',
        'denis',
        'dese',
        'dfij',
        'dgal',
        'dgal2',
        'dgme',
        'dgmx',
        'dgul',
        'dgum',
        'dgum2',
        'dhai',
        'dhai2',
        'dhaw',
        'dhaw2',
        'dhnn',
        'dhon',
        'dhon2',
        'dhta',
        'diel',
        'diep',
        'dind',
        'diw2',
        'diwa',
        'djib',
        'djun',
        'djve',
        'djve2',
        'djvw',
        'dkam',
        'dkam2',
        'dkod',
        'dkod2',
        'dkui',
        'dkur',
        'dkur2',
        'dkwa',
        'dkwa2',
        'dlim',
        'dlos',
        'dlpr',
        'dmaa',
        'dmab',
        'dmar',
        'dmiy',
        'dmnz',
        'dmon',
        'dmon2',
        'dnew',
        'dni1',
        'dni3',
        'dni4',
        'dni6',
        'dni7',
        'dnic',
        'dnic2',
        'dnor',
        'dnwp',
        'dnwp2',
        'dnza',
        'dnza2',
        'dnzb',
        'dnzb2',
        'dnzc',
        'dnzc2',
        'dnzd',
        'dnzd2',
        'dnze',
        'dnze2',
        'dnzf',
        'dnzg',
        'dnzg2',
        'dnzh',
        'dnzh2',
        'dnzi',
        'dnzi2',
        'dnzj',
        'dnzj2',
        'dnzk',
        'dnzk2',
        'dnzl',
        'dorg',
        'dorg2',
        'dpan',
        'dpea',
        'dpeb',
        'dper',
        'dphi',
        'dpor',
        'drag',
        'drus',
        'dryu',
        'dryu2',
        'dsac',
        'dsai',
        'dsdi',
        'dsea',
        'dsea2',
        'dsen',
        'dshu',
        'dsim',
        'dstl',
        'dta2',
        'dta3',
        'dta4',
        'dtai',
        'dtas',
        'dtas2',
        'dtok',
        'dtok2',
        'dton',
        'dtru',
        'dtru2',
        'dumo',
        'duni',
        'dunk',
        'durb',
        'dutc',
        'dutc2',
        'dval',
        'dval2',
        'dzao',
        'e4bs',
        'east',
        'east2',
        'ebla',
        'efjm',
        'eila',
        'elak',
        'elat',
        'elja1',
        'ellb',
        'enap',
        'ENGSI',
        'ense',
        'epme',
        'erdek',
        'erdem',
        'esbj',
        'esme',
        'espr',
        'estr',
        'exmt',
        'fbfl',
        'fer1',
        'fer2',
        'feth',
        'ffcj',
        'figu',
        'figu2',
        'fish',
        'flam',
        'fli16',
        'fli7',
        'flma',
        'fmfl',
        'fong',
        'form',
        'fors',
        'fort',
        'fort2',
        'fosm2',
        'fpga',
        'fpnt2',
        'fptx',
        'fred',
        'freh',
        'fren',
        'frih',
        'frot',
        'frtr',
        'ftfr',
        'fue2',
        'fuer2',
        'furu',
        'futu',
        'fyns',
        'GA37',
        'gamb',
        'gand',
        'ganm',
        'gaor',
        'gara1',
        'gaso',
        'gazi',
        'GE25',
        'geds',
        'geor',
        'GESJI',
        'GI20',
        'gibr',
        'gibr2',
        'gibr3',
        'gij2',
        'girn',
        'goag',
        'goer',
        'gohi',
        'gokc',
        'golf',
        'goti',
        'goug',
        'greg',
        'greg2',
        'GRJJI',
        'guam',
        'guam2',
        'guar',
        'gvd9',
        'gyer',
        'hade',
        'hade2',
        'haif',
        'halei',
        'hali',
        'hamb',
        'hamm',
        'hanl',
        'hanst',
        'hars',
        'harv',
        'heeia',
        'heim',
        'helgz',
        'hens',
        'herb',
        'herb2',
        'heys',
        'hie2',
        'hien2',
        'hilo',
        'hink',
        'hirt',
        'hiva',
        'hoko',
        'holm',
        'holy',
        'holy2',
        'honn',
        'hono',
        'hornb',
        'hrak',
        'htst',
        'huach',
        'huahi',
        'huarm',
        'huas',
        'huas2',
        'huat',
        'huel',
        'iaix',
        'ibiz',
        'iclr',
        'iera',
        'igne',
        'iler',
        'ilha',
        'ilom',
        'ilom2',
        'IM01',
        'imbi',
        'imbt',
        'imbt2',
        'imek',
        'imuj',
        'inha',
        'iqui',
        'iqui2',
        'isfu',
        'ishig',
        'IsHor',
        'iske',
        'ista',
        'IT45',
        'itea',
        'jaca',
        'jask',
        'jers',
        'john',
        'juac',
        'juan',
        'juan2',
        'june',
        'jute',
        'kabe',
        'kaci',
        'kahu',
        'kahu2',
        'kaka',
        'kala',
        'kalit',
        'kalm',
        'kalt',
        'kame',
        'kant',
        'kapi',
        'kaps',
        'karl',
        'kaso',
        'kast',
        'kata',
        'kaum',
        'kaun',
        'kawa',
        'keba',
        'keehi',
        'kepo',
        'kepo1',
        'kerg',
        'kerg2',
        'ketc',
        'kgak',
        'khol',
        'kiel',
        'kinl',
        'kis1',
        'kisr',
        'kjni',
        'KMMSI',
        'kobe',
        'kodi',
        'komi',
        'koro',
        'kors',
        'korso',
        'kos1',
        'kos2',
        'kota',
        'kpva',
        'kril',
        'kris',
        'krna',
        'kung',
        'kuri',
        'KUTBI',
        'kwaj',
        'kwfl',
        'kypa',
        'LA23',
        'LA38',
        'lacr',
        'lago',
        'lagos',
        'lajo',
        'lali',
        'lame2',
        'LAMSI',
        'land',
        'lang',
        'lapa',
        'lapu',
        'larn',
        'larn2',
        'larp',
        'larp2',
        'lasp',
        'laza',
        'lcla',
        'lcst',
        'lebu',
        'lebu2',
        'leco',
        'leco2',
        'lecy',
        'lede',
        'leha',
        'leha2',
        'leir',
        'leme',
        'lerw2',
        'leso',
        'leso2',
        'leva',
        'lgos',
        'LI11',
        'lifo2',
        'lime',
        'live',
        'live2',
        'ljus',
        'llan',
        'lmma',
        'lobo2',
        'lobos',
        'losu',
        'lpaz',
        'lpbc',
        'lton',
        'lund',
        'lymg',
        'madry',
        'maer',
        'magi',
        'maho',
        'mais',
        'maka',
        'make',
        'mal3',
        'mala',
        'Male2',
        'malh',
        'mali',
        'malk',
        'malp',
        'malp2',
        'malt',
        'mane',
        'mang',
        'mant',
        'manz',
        'mare',
        'mare2',
        'mari',
        'marn1',
        'mars',
        'marsh',
        'masi2',
        'mata',
        'mata2',
        'matr',
        'mavh',
        'maza',
        'MC41',
        'ME13',
        'meji',
        'meji2',
        'meli',
        'ment',
        'meul',
        'mhav',
        'mhpa',
        'midx',
        'midx2',
        'mill',
        'milo',
        'mimz',
        'mimz2',
        'mind',
        'mins',
        'miqu',
        'MNPL',
        'mnts',
        'moal',
        'moku',
        'mona',
        'mona2',
        'monc',
        'monc2',
        'mont',
        'mony',
        'motr',
        'moul',
        'mpaw',
        'mpcw',
        'mphw',
        'mpsw',
        'mpww',
        'mrig',
        'mrms',
        'MRTM',
        'MRTMI',
        'ms001',
        'ms003',
        'mtwa',
        'mumb',
        'murc2',
        'mus2',
        'musc3',
        'myko',
        'NA23',
        'nafl',
        'naho',
        'nain',
        'nans',
        'narv',
        'naur',
        'nauu',
        'nawi',
        'nbpa',
        'nbrt',
        'ncla',
        'neah',
        'neve',
        'newl2',
        'newl3',
        'nhte',
        'nice',
        'nice2',
        'nieu',
        'niki',
        'niko',
        'nkfa',
        'nkfa2',
        'nksk',
        'noat',
        'noct',
        'nome',
        'noua',
        'npor',
        'nspi',
        'ntue',
        'ntue2',
        'nuk1',
        'nuku',
        'numb2',
        'nyal',
        'nyna',
        'ocmd',
        'ofuas',
        'ohig',
        'ohig3',
        'oinc',
        'olan',
        'OR24',
        'osca',
        'oska',
        'oslo',
        'oste1',
        'OT15',
        'ouin2',
        'ouis',
        'ouve2',
        'oxel',
        'PA07',
        'paak',
        'pada',
        'pagb',
        'pagi',
        'pagi2',
        'pagx',
        'pait2',
        'paita',
        'palb',
        'pale',
        'pall',
        'palm',
        'palm1',
        'pang',
        'pano',
        'pant',
        'papa',
        'pape',
        'pape2',
        'papho',
        'papo',
        'papo2',
        'para',
        'parg',
        'parh',
        'pass',
        'pata',
        'pata2',
        'patu',
        'PAYJI',
        'pbbc',
        'pbfl',
        'pbil',
        'pblu',
        'pbol',
        'pcas',
        'pcfl',
        'pcha',
        'pcha2',
        'pchi',
        'pcrt',
        'pdas',
        'PDCR',
        'PE09',
        'pece',
        'pedn',
        'pedn2',
        'peir',
        'PEISI',
        'pele',
        'pemba',
        'penr',
        'penu',
        'petr',
        'pfla',
        'pgrau',
        'phar',
        'phbc',
        'phpa',
        'pich',
        'pich2',
        'pisa',
        'pisa2',
        'pisc2',
        'pisco',
        'pitx',
        'PL14',
        'plat',
        'plat2',
        'PLBR',
        'plim',
        'plmy',
        'plom',
        'plop',
        'pluz',
        'pmel',
        'pmel2',
        'pmon',
        'pmon2',
        'pnat',
        'pnfl',
        'pnfo',
        'pntn',
        'PO40',
        'pont',
        'porf',
        'poro',
        'porp',
        'pors',
        'port',
        'port2',
        'posa',
        'posi',
        'pots',
        'ppcp',
        'prai',
        'prat3',
        'prch',
        'prec',
        'preo',
        'prev',
        'prin2',
        'prog',
        'prog2',
        'prsc',
        'prsj',
        'prte',
        'PRTP',
        'prud',
        'prus',
        'psai',
        'PSCA',
        'psla',
        'PT17',
        'ptal',
        'ptal2',
        'ptan',
        'ptar',
        'ptar2',
        'ptbc',
        'ptch',
        'ptfe',
        'ptfe2',
        'ptga',
        'ptis',
        'ptln',
        'ptln2',
        'ptma',
        'ptmd',
        'ptos',
        'ptos2',
        'ptow',
        'ptpt',
        'ptre',
        'ptro',
        'ptsc',
        'ptve',
        'ptve2',
        'puer2',
        'pumo',
        'puna',
        'punt',
        'pwil',
        'pwil2',
        'qaqo',
        'qcbc',
        'qtro',
        'qtro2',
        'quel',
        'quel2',
        'quir',
        'quir2',
        'RA10',
        'raba',
        'rangi',
        'raro',
        'raro2',
        'rata',
        'rbct',
        'RC09',
        'RCCL',
        'redg',
        'redw',
        'reun',
        'reyk',
        'rfrt',
        'riba',
        'rig2',
        'riki',
        'rodb',
        'rorv',
        'rosc',
        'rosc2',
        'rote',
        'rothe',
        'rous',
        'rous2',
        'rptx',
        'rudn',
        'SA16',
        'sagr',
        'sagu',
        'said',
        'sain',
        'sain2',
        'saip',
        'sala2',
        'salav',
        'sali',
        'salv',
        'salv3',
        'sama2',
        'sams',
        'san2',
        'sanb',
        'Sandn',
        'sanf',
        'sanf3',
        'sanj',
        'sanm',
        'sano',
        'sano2',
        'sanp',
        'sant',
        'saot',
        'sapz',
        'SB36',
        'sbea',
        'SC43',
        'scoa',
        'scoa2',
        'scor',
        'sdom',
        'sdpr',
        'sdpt',
        'sebla',
        'seld',
        'sete',
        'sete2',
        'setu',
        'sev2',
        'seve',
        'sewa',
        'shee2',
        'shnj',
        'sian',
        'sian2',
        'siga',
        'sile',
        'simd',
        'simp',
        'simr',
        'SIMSI',
        'sino',
        'sipa',
        'sira',
        'sire',
        'sitin',
        'sitk',
        'sjua2',
        'sjuan',
        'skag',
        'skagk',
        'skan',
        'slip',
        'slit',
        'slor',
        'smag',
        'smar',
        'SMLE',
        'smth',
        'sobr',
        'sola',
        'sole',
        'sole2',
        'solo',
        'solu',
        'sona',
        'sosu',
        'sove',
        'sped',
        'spfl',
        'spik',
        'spmi',
        'sptx',
        'SRMPI',
        'sscr',
        'ST44',
        'stan',
        'stan2',
        'star',
        'stari',
        'stav',
        'stcr',
        'sthl2',
        'sthm',
        'stjo',
        'stlo2',
        'stma',
        'stma2',
        'stmr',
        'stmt',
        'stor',
        'stpa',
        'stqy',
        'stqy2',
        'stro',
        'SUBSI',
        'supe',
        'swpr',
        'syow',
        'syro',
        'TA18',
        'tala2',
        'talc',
        'talc2',
        'talt',
        'talt2',
        'tame',
        'tanjo',
        'tara',
        'tara1',
        'tari',
        'tarr',
        'TASJI',
        'tasu',
        'tasw',
        'tauas',
        'taza',
        'TBSSI',
        'tbvi2',
        'tcgt2',
        'tcsb',
        'tdcu',
        'tdon',
        'TEDSI',
        'tejn',
        'tela',
        'telu',
        'tema',
        'tene',
        'TEUL',
        'tfbc',
        'thes',
        'thua',
        'thul',
        'tjls',
        'tkdi',
        'TLBJI',
        'tluk',
        'tn031',
        'tnbl',
        'tnpr',
        'tobe',
        'toco',
        'toco2',
        'tofi',
        'tort',
        'toul',
        'toul2',
        'tpfl',
        'TR22',
        'trab',
        'trae',
        'trai',
        'trem',
        'trom',
        'tron',
        'tst1',
        'tubua',
        'tuca',
        'tudy',
        'tumc',
        'tumc2',
        'turb',
        'tuxp',
        'UAPO',
        'ugle',
        'uht1',
        'ulla',
        'uper',
        'ushu',
        'usti',
        'ustk',
        'util',
        'vair',
        'vald',
        'vald2',
        'vale',
        'valp',
        'valp2',
        'vard',
        'VE19',
        'vela',
        'vera',
        'vern',
        'vhbc',
        'VI12',
        'vibc',
        'vieq',
        'vig2',
        'vike',
        'vil2',
        'visb',
        'vkfl',
        'vlad',
        'vodo',
        'vsfb',
        'vung',
        'vvik',
        'waian',
        'waik',
        'wait',
        'wake',
        'wake2',
        'wall',
        'wall2',
        'walvi',
        'wava',
        'wbnc',
        'whbc',
        'wilb',
        'will',
        'winc',
        'WIS05',
        'wlms2',
        'wood',
        'wsdc',
        'xish',
        'xmas',
        'yaku',
        'yalo',
        'yapi',
        'yobu',
        'ysta',
        'yuzh',
        'zihu',
        'zkth',
        'zldw',
        'zwdw',
        'zygi1',
    ]

    logger.info(f"计划抓取以下站点: {target_stations}")

    for code in target_stations:
        # 1. 获取数据 (返回成功数据 和 失败片段)
        full_year_data, failures = fetch_station_annual_data(code)

        # 2. 保存成功的数据
        if full_year_data:
            save_to_csv(code, full_year_data)

        # 3. 保存失败的片段 (如果有)
        if failures:
            save_failures(failures)

        logger.info("-" * 30)

    logger.info("所有任务完成。")


if __name__ == '__main__':
    main()
